process.env.NODE_ENV = 'test';

import app from '../app.js'
import mongoose from 'mongoose';
import User from '../models/user.js';
import { expect } from 'chai';
import supertest from 'supertest';

console.log(process.env.NODE_ENV, "!!!!!!!!");

describe('users endpoints', () => {
    let request ;

    before(function (done) {
        request = supertest.agent(app);

        mongoose.connect(`mongodb://Test:${encodeURIComponent('AppGu@rd')}@localhost/monitoring_test?auth_source=admin`, function(error) {
            if (error) console.error('Error while connecting:\n%\n', error);
            console.log('connected');
            done(error);
        });

    });

    after(function (done) {
            // shut down the Express.js server, close our MongoDB connection, then
            // tell Mocha we're done:
            app.close(() => {
                mongoose.connection.close(done);
            });
    });

    
    it('should allow a POST to /users', async function () {
        const res = await request.post('/users').send(firstUserBody);
    
        expect(res.status).to.equal(201);
        expect(res.body).not.to.be.empty;
        expect(res.body).to.be.an('object');
        expect(res.body.id).to.be.a('string');
        firstUserIdTest = res.body.id;
       
    });
});